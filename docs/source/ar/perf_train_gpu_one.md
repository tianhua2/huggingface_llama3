# ุทุฑู ูุฃุฏูุงุช ููุชุฏุฑูุจ ุงููุนุงู ุนูู ูุนุงูุฌ ุฑุณููุงุช ูุงุญุฏ

ููุถุญ ูุฐุง ุงูุฏููู ุงูุชูููุงุช ุงูุนูููุฉ ุงูุชู ููููู ุงุณุชุฎุฏุงููุง ูุฒูุงุฏุฉ ููุงุกุฉ ุชุฏุฑูุจ ุงููููุฐุฌ ุงูุฎุงุต ุจู ูู ุฎูุงู ุชุญุณูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉุ ุฃู ุชุณุฑูุน ุงูุชุฏุฑูุจุ ุฃู ูููููุง. ุฅุฐุง ููุช ุชุฑุบุจ ูู ููู ููููุฉ ุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุฃุซูุงุก ุงูุชุฏุฑูุจุ ูุฑุฌู ุงูุฑุฌูุน ุฃููุงู ุฅูู ุงูุฏููู ุงูููุงูููู [ุชุดุฑูุญ ุชุฏุฑูุจ ุงููููุฐุฌ](model_memory_anatomy). ูุฑูุฒ ูุฐุง ุงูุฏููู ุนูู ุงูุชูููุงุช ุงูุนูููุฉ.

<Tip>

ุฅุฐุง ูุงู ูุฏูู ุฅููุงููุฉ ุงููุตูู ุฅูู ุฌูุงุฒ ุจู ุนุฏุฉ ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุงุช (GPUs)ุ ููุง ุชุฒุงู ูุฐู ุงูุฃุณุงููุจ ุตุงูุญุฉุ ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ููููู ุงูุงุณุชูุงุฏุฉ ูู ุงูุฃุณุงููุจ ุงูุฅุถุงููุฉ ุงูููุถุญุฉ ูู ูุณู [ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงููุชุนุฏุฏุฉ](perf_train_gpu_many).

</Tip>

ุนูุฏ ุชุฏุฑูุจ ุงูููุงุฐุฌ ุงููุจูุฑุฉุ ููุงู ุฌุงูุจุงู ูุฌุจ ุฃุฎุฐููุง ูู ุงูุงุนุชุจุงุฑ ูู ููุณ ุงูููุช:

* *ูุนุฏู ููู ุงูุจูุงูุงุช/ููุช ุงูุชุฏุฑูุจ:* ุฒูุงุฏุฉ ูุนุฏู ููู ุงูุจูุงูุงุช (ุนุฏุฏ ุงูุนููุงุช ูู ุงูุซุงููุฉ) ูุคุฏู ุฅูู ุชูููู ุชูููุฉ ุงูุชุฏุฑูุจ. ููุชู ุชุญููู ุฐูู ุจุดูู ุนุงู ูู ุฎูุงู ุงูุงุณุชูุงุฏุฉ ุงููุตูู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูุจุงูุชุงูู ููุก ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุฅูู ุงูุญุฏ ุงูุฃูุตู. ุฅุฐุง ุชุฌุงูุฒ ุญุฌู ุงูุฏูุนุฉ ุงููุทููุจ ุญุฏูุฏ ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU)ุ ููููู ูุชูููุงุช ุชุญุณูู ุงูุฐุงูุฑุฉุ ูุซู ุชุฑุงูู ุงูุชุฏุฑุฌุงุชุ ุฃู ุชุณุงุนุฏ ูู ุฐูู.

* *ุฃุฏุงุก ุงููููุฐุฌ:* ููุน ุฐููุ ุฅุฐุง ูุงู ุญุฌู ุงูุฏูุนุฉ ุงูููุถู ููุงุณุจ ุงูุฐุงูุฑุฉุ ููุง ููุฌุฏ ุณุจุจ ูุชุทุจูู ุชูููุงุช ุชุญุณูู ุงูุฐุงูุฑุฉ ูุฃููุง ูููู ุฃู ุชุจุทุฆ ุงูุชุฏุฑูุจ. ูุฌุฑุฏ ุฃู ูููู ุงููุฑุก ูุงุฏุฑูุง ุนูู ุงุณุชุฎุฏุงู ุญุฌู ุฏูุนุฉ ูุจูุฑุ ูุง ูุนูู ุจุงูุถุฑูุฑุฉ ุฃูู ููุจุบู ุนููู ุฐูู. ูุฌุฒุก ูู ุถุจุท ุงููุนููุงุชุ ูุฌุจ ุนููู ุชุญุฏูุฏ ุญุฌู ุงูุฏูุนุฉ ุงูุฐู ูุญูู ุฃูุถู ุงููุชุงุฆุฌ ุซู ุชุญุณูู ุงูููุงุฑุฏ ููููุง ูุฐูู.

ูููู ุชุตููู ุงูุทุฑู ูุงูุฃุฏูุงุช ุงููุดูููุฉ ูู ูุฐุง ุงูุฏููู ุจูุงุกู ุนูู ุงูุชุฃุซูุฑ ุงูุฐู ุชุญุฏุซู ุนูู ุนูููุฉ ุงูุชุฏุฑูุจ:

| ุงูุทุฑููุฉ/ุงูุฃุฏุงุฉ | ุชุญุณูู ุณุฑุนุฉ ุงูุชุฏุฑูุจ | ุชุญุณูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ |
|:------------------------:|:----------------------:|:-------------------------:|
| [ุงุฎุชูุงุฑ ุญุฌู ุงูุฏูุนุฉ](#batch-size-choice) | ูุนู | ูุนู |
| [ุชุฑุงูู ุงูุชุฏุฑุฌ](#gradient-accumulation) | ูุง | ูุนู |
| [ุงูุชุฏููู ุงูุชุฏุฑูุฌู](#gradient-checkpointing) | ูุง | ูุนู |
| [ุชุฏุฑูุจ ุงูุฏูุฉ ุงููุฎุชูุทุฉ](#mixed-precision-training) | ูุนู | ุฑุจูุง* |
| [torch_empty_cache_steps](https://huggingface.co/docs/transformers/main/en/main_classes/trainer#transformers.TrainingArguments.torch_empty_cache_steps) | ูุง | ูุนู |
| [ุงุฎุชูุงุฑ ุงููุญุณู](#optimizer-choice) | ูุนู | ูุนู |
| [ุงูุชุญููู ุงููุณุจู ููุจูุงูุงุช](#data-preloading) | ูุนู | ูุง |
| [DeepSpeed Zero](#deepspeed-zero) | ูุง | ูุนู |
| [torch.compile](#using-torchcompile) | ูุนู | ูุง |
| [ุถุจุท ุฏููู ูุนุงู ูููุนููุงุช (PEFT)](#using--peft) | ูุง | ูุนู |

<Tip>

*ููุงุญุธุฉ: ุนูุฏ ุงุณุชุฎุฏุงู ุงูุฏูุฉ ุงููุฎุชูุทุฉ ูุน ูููุฐุฌ ุตุบูุฑ ูุญุฌู ุฏูุนุฉ ูุจูุฑุ ุณุชููู ููุงู ุจุนุถ ุงููููุฑุงุช ูู ุงูุฐุงูุฑุฉ ูููู ูุน ูููุฐุฌ ูุจูุฑ ูุญุฌู ุฏูุนุฉ ุตุบูุฑุ ุณูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุฃูุจุฑ.

</Tip>

ููููู ุงูุฌูุน ุจูู ุงูุทุฑู ุงููุฐููุฑุฉ ุฃุนูุงู ููุญุตูู ุนูู ุชุฃุซูุฑ ุชุฑุงููู. ุชุชููุฑ ูุฐู ุงูุชูููุงุช ุณูุงุก ููุช ุชููู ุจุชุฏุฑูุจ ูููุฐุฌู ุจุงุณุชุฎุฏุงู [`Trainer`] ุฃู ูุชุงุจุฉ ุญููุฉ PyTorch ูููุฉุ ููู ูุฐู ุงูุญุงูุฉ ููููู [ุชูููู ูุฐู ุงูุชุญุณููุงุช ุจุงุณุชุฎุฏุงู Accelerate](#using--accelerate).

ุฅุฐุง ูู ุชุคุฏ ูุฐู ุงูุทุฑู ุฅูู ููุงุณุจ ูุงููุฉุ ูููููู ุงุณุชูุดุงู ุงูุฎูุงุฑุงุช ุงูุชุงููุฉ:
* ุงูุจุญุซ ูู ุจูุงุก ุญุงููุฉ Docker ูุฎุตุตุฉ ุฎุงุตุฉ ุจู ูุน ุจุฑุงูุฌ ูุณุจูุฉ ุงูุจูุงุก ูุนุงูุฉ
* ุงููุธุฑ ูู ูููุฐุฌ ูุณุชุฎุฏู ูุฒูุฌูุง ูู ุงูุฎุจุฑุงุก (MoE)
* ุชุญููู ูููุฐุฌู ุฅูู BetterTransformer ููุงุณุชูุงุฏุฉ ูู ุงูุงูุชูุงู ุงูุฃุตูู ูู PyTorch

ุฃุฎูุฑูุงุ ุฅุฐุง ูู ููู ูู ูุง ุณุจู ูุงูููุงุ ุญุชู ุจุนุฏ ุงูุชุจุฏูู ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณูููุงุช (GPU) ูู ูุฆุฉ ุงูุฎูุงุฏู ูุซู A100ุ ูููุฑ ูู ุงูุงูุชูุงู ุฅูู ุฅุนุฏุงุฏ ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณูููุงุช (GPU) ูุชุนุฏุฏุฉ. ูุง ุชุฒุงู ุฌููุน ูุฐู ุงูุฃุณุงููุจ ุตุงูุญุฉ ูู ุฅุนุฏุงุฏ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูุชุนุฏุฏุฉุ ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ููููู ุงูุงุณุชูุงุฏุฉ ูู ุชูููุงุช ุงูุชูุงุฒู ุงูุฅุถุงููุฉ ุงูููุถุญุฉ ูู ูุณู [ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงููุชุนุฏุฏุฉ](perf_train_gpu_many).

## ุงุฎุชูุงุฑ ุญุฌู ุงูุฏูุนุฉ
## ุงุฎุชูุงุฑ ุญุฌู ุงูุฏูุนุฉ

ูุชุญููู ุงูุฃุฏุงุก ุงูุฃูุซูุ ุงุจุฏุฃ ุจุชุญุฏูุฏ ุญุฌู ุงูุฏูุนุฉ ุงูููุงุณุจ. ูููุตุญ ุจุงุณุชุฎุฏุงู ุฃุญุฌุงู ุฏูุนุงุช ูุนุฏุฏ ุนุตุจููุงุช ุงูุฅุฏุฎุงู/ุงูุฅุฎุฑุงุฌ ุงูุชู ุชููู ูู ุญุฌู 2^N. ุบุงูุจูุง ูุง ูููู ูุฐุง ุงูุนุฏุฏ ูุถุงุนููุง ููุฑูู 8ุ ููููู ูุฏ ูููู ุฃุนูู ุงุนุชูุงุฏูุง ุนูู ุงูุฃุฌูุฒุฉ ุงููุณุชุฎุฏูุฉ ูููุน ุงูุจูุงูุงุช dtype ุงููุณุชุฎุฏูุฉ ูู ุงููููุฐุฌ.

ููุฅุดุงุฑุฉุ ุฑุงุฌุน ุชูุตูุฉ NVIDIA ูุญุณุงุจ [ุนุฏุฏ ุนุตุจููุงุช ุงูุฅุฏุฎุงู/ุงูุฅุฎุฑุงุฌ](https://docs.nvidia.com/deeplearning/performance/dl-performance-fully-connected/index.html#input-features) ู[ุญุฌู ุงูุฏูุนุฉ](https://docs.nvidia.com/deeplearning/performance/dl-performance-fully-connected/index.html#batch-size) ููุทุจูุงุช ุงููุชุตูุฉ ุชูุงููุง (ุงูุชู ุชุดุงุฑู ูู ุนูููุงุช ุงูุถุฑุจ ุงูุนุงู ูููุตูููุงุช).

ุชุญุฏุฏ [ูุชุทูุจุงุช Tensor Core](https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#requirements-tc) ุงููุถุงุนู ุจูุงุกู ุนูู ููุน ุงูุจูุงูุงุช dtype ูุงูุฃุฌูุฒุฉ ุงููุณุชุฎุฏูุฉ. ุนูู ุณุจูู ุงููุซุงูุ ุจุงููุณุจุฉ ูููุน ุงูุจูุงูุงุช fp16ุ ูููุตุญ ุจุงุณุชุฎุฏุงู ูุถุงุนูุงุช ุงูุฑูู 8ุ ุฅูุง ุฅุฐุง ูุงู ุงูุฃูุฑ ูุชุนูู ุจุจุทุงูุฉ GPU ูู ููุน A100ุ ููู ูุฐู ุงูุญุงูุฉุ ุงุณุชุฎุฏู ูุถุงุนูุงุช 64.

ุจุงููุณุจุฉ ูููุนููุงุช ุงูุตุบูุฑุฉุ ุถุน ูู ุงุนุชุจุงุฑู ุฃูุถูุง [ุขุซุงุฑ ุงูุชูููู ุงูุฃุจุนุงุฏ](https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#dim-quantization). ููุง ูุญุฏุซ ุงูุชุจููุท ููููู ุฃู ูุคุฏู ุงููุถุงุนู ุงูุตุญูุญ ุฅูู ุชุณุฑูุน ูุจูุฑ.

## ุชุฌููุน ุงูุชุฏุฑุฌุงุช

ุชูุฏู ุทุฑููุฉ **ุชุฌููุน ุงูุชุฏุฑุฌุงุช** ุฅูู ุญุณุงุจ ุงูุชุฏุฑุฌุงุช ุนูู ุดูู ุฃูุณุงู ุฃุตุบุฑ ุจุฏูุงู ูู ุญุณุงุจูุง ุฏูุนุฉ ูุงุญุฏุฉ ููุฏูุนุฉ ุจุฃููููุง. ูุชุถูู ูุฐุง ุงูููุฌ ุญุณุงุจ ุงูุชุฏุฑุฌุงุช ุจุดูู ุชูุฑุงุฑู ูู ุฏูุนุงุช ุฃุตุบุฑ ุนู ุทุฑูู ุชูููุฐ ุนูููุงุช ุชูุฑูุฑ ููุฃูุงู ูุงูุฎูู ุนุจุฑ ุงููููุฐุฌ ูุชุฌููุน ุงูุชุฏุฑุฌุงุช ุฃุซูุงุก ูุฐู ุงูุนูููุฉ. ุจูุฌุฑุฏ ุชุฌููุน ุนุฏุฏ ูุงูู ูู ุงูุชุฏุฑุฌุงุชุ ูุชู ุชูููุฐ ุฎุทูุฉ ุงูุชุญุณูู ูููููุฐุฌ. ูู ุฎูุงู ุงุณุชุฎุฏุงู ุชุฌููุน ุงูุชุฏุฑุฌุงุชุ ูุตุจุญ ูู ุงููููู ุฒูุงุฏุฉ **ุญุฌู ุงูุฏูุนุฉ ุงููุนุงู** ุฅูู ูุง ุจุนุฏ ุงููููุฏ ุงูุชู ุชูุฑุถูุง ุณุนุฉ ุฐุงูุฑุฉ GPU. ููุน ุฐููุ ูู ุงูููู ููุงุญุธุฉ ุฃู ุนูููุงุช ุงูุชูุฑูุฑ ุงูุฅุถุงููุฉ ููุฃูุงู ูุงูุฎูู ุงูุชู ูุฏููุง ุชุฌููุน ุงูุชุฏุฑุฌุงุช ูููู ุฃู ุชุจุทุฆ ุนูููุฉ ุงูุชุฏุฑูุจ.

ููููู ุชูููู ุชุฌููุน ุงูุชุฏุฑุฌุงุช ุนู ุทุฑูู ุฅุถุงูุฉ ูุณูุท `gradient_accumulation_steps` ุฅูู [`TrainingArguments`]:

```py
training_args = TrainingArguments(per_device_train_batch_size=1, gradient_accumulation_steps=4, **default_args)
```

ูู ุงููุซุงู ุฃุนูุงูุ ูุตุจุญ ุญุฌู ุงูุฏูุนุฉ ุงููุนุงู ูุฏูู 4.

ุฃูุ ุงุณุชุฎุฏู ๐ค Accelerate ููุชุญูู ุงููุงูู ูู ุญููุฉ ุงูุชุฏุฑูุจ. ุงุจุญุซ ุนู ูุซุงู ๐ค Accelerate [ูู ุงูุฃุณูู ูู ูุฐุง ุงูุฏููู](#using-accelerate).

ูู ุญูู ูููุตุญ ุจุฒูุงุฏุฉ ุงุณุชุฎุฏุงู GPU ูุฏุฑ ุงูุฅููุงูุ ูููู ุฃู ูุคุฏู ุงุฑุชูุงุน ุนุฏุฏ ุฎุทูุงุช ุชุฌููุน ุงูุชุฏุฑุฌุงุช ุฅูู ุชุจุงุทุค ููุญูุธ ูู ุงูุชุฏุฑูุจ. ุถุน ูู ุงุนุชุจุงุฑู ุงููุซุงู ุงูุชุงูู. ูููุชุฑุถ ุฃู `per_device_train_batch_size=4` ุจุฏูู ุชุฌููุน ุงูุชุฏุฑุฌุงุช ูุตู ุฅูู ุญุฏ GPU. ุฅุฐุง ููุช ุชุฑุบุจ ูู ุงูุชุฏุฑูุจ ุจุงุณุชุฎุฏุงู ุฏูุนุงุช ุจุญุฌู 64ุ ููุง ุชูู ุจุชุนููู `per_device_train_batch_size` ุฅูู 1 ู`gradient_accumulation_steps` ุฅูู 64. ุจุฏูุงู ูู ุฐููุ ุงุญุชูุธ ุจู `per_device_train_batch_size=4` ููู ุจุชุนููู `gradient_accumulation_steps=16`. ูุคุฏู ูุฐุง ุฅูู ููุณ ุญุฌู ุงูุฏูุนุฉ ุงููุนุงู ูุน ุงูุงุณุชูุงุฏุฉ ุจุดูู ุฃูุถู ูู ููุงุฑุฏ GPU ุงููุชุงุญุฉ.

ููุญุตูู ุนูู ูุนูููุงุช ุฅุถุงููุฉุ ูุฑุฌู ุงูุฑุฌูุน ุฅูู ูุนุงููุฑ ุญุฌู ุงูุฏูุนุฉ ูุชุฌููุน ุงูุชุฏุฑุฌุงุช ูู [RTX-3090](https://github.com/huggingface/transformers/issues/14608#issuecomment-1004392537) ู [A100](https://github.com/huggingface/transformers/issues/15026#issuecomment-1005033957).

## ููุงุท ุชูุชูุด ุงูุชุฏุฑุฌ

ูุฏ ุชูุงุฌู ุจุนุถ ุงูููุงุฐุฌ ุงููุจูุฑุฉ ูุดููุงุช ูู ุงูุฐุงูุฑุฉ ุญุชู ุนูุฏ ุชุนููู ุญุฌู ุงูุฏูุนุฉ ุฅูู 1 ูุงุณุชุฎุฏุงู ุชุฌููุน ุงูุชุฏุฑุฌุงุช. ููุฑุฌุน ุฐูู ุฅูู ูุฌูุฏ ููููุงุช ุฃุฎุฑู ุชุชุทูุจ ุฃูุถูุง ูุณุงุญุฉ ุชุฎุฒูู ููุฐุงูุฑุฉ.

ูููู ุฃู ูุคุฏู ุญูุธ ุฌููุน ุงูุชูุดูุทุงุช ูู ุชูุฑูุฑ ุงูุฅุฑุณุงู ูุญุณุงุจ ุงูุชุฏุฑุฌุงุช ุฃุซูุงุก ุชูุฑูุฑ ุงูุนูุฏุฉ ุฅูู ุฒูุงุฏุฉ ูุจูุฑุฉ ูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช. ูุงูููุฌ ุงูุจุฏูู ุงููุชูุซู ูู ุงูุชุฎูุต ูู ุงูุชูุดูุทุงุช ูุฅุนุงุฏุฉ ุญุณุงุจูุง ุนูุฏ ุงูุญุงุฌุฉ ุฃุซูุงุก ุชูุฑูุฑ ุงูุนูุฏุฉุ ูู ุดุฃูู ุฃู ูุคุฏู ุฅูู ุฒูุงุฏุฉ ูุจูุฑุฉ ูู ุงูุนุจุก ุงูุญุณุงุจู ูุฅุจุทุงุก ุนูููุฉ ุงูุชุฏุฑูุจ.

ุชูุฏู **ููุงุท ุชูุชูุด ุงูุชุฏุฑุฌ** ุญููุง ูุณุทูุง ุจูู ูุฐูู ุงูููุฌููุ ุญูุซ ุชููู ุจุญูุธ ุงูุชูุดูุทุงุช ุงููุฎุชุงุฑุฉ ุจุดูู ุงุณุชุฑุงุชูุฌู ูู ุฌููุน ุฃูุญุงุก ุงูุฑุณู ุงูุจูุงูู ุงูุญุณุงุจูุ ุจุญูุซ ูุง ููุฒู ุฅุนุงุฏุฉ ุญุณุงุจ ุณูู ุฌุฒุก ูู ุงูุชูุดูุทุงุช ููุชุฏุฑุฌุงุช. ููุญุตูู ุนูู ุดุฑุญ ูุชุนูู ูููุงุท ุชูุชูุด ุงูุชุฏุฑุฌุ ุฑุงุฌุน [ูุฐู ุงูููุงูุฉ ุงูุฑุงุฆุนุฉ](https://medium.com/tensorflow/fitting-larger-networks-into-memory-583e3c758ff9).

ูุชูููู ููุงุท ุชูุชูุด ุงูุชุฏุฑุฌ ูู [`Trainer`]ุ ูู ุจุชูุฑูุฑ ุงูุนูุงูุฉ ุงูููุงุจูุฉ ุฅูู [`TrainingArguments`]:

```py
training_args = TrainingArguments(
    per_device_train_batch_size=1, gradient_accumulation_steps=4, gradient_checkpointing=True, **default_args
)
```

ุฃูุ ุงุณุชุฎุฏู ๐ค Accelerate - ุงุจุญุซ ุนู ูุซุงู ๐ค Accelerate [ูู ุงูุฃุณูู ูู ูุฐุง ุงูุฏููู](#using--accelerate). 

<Tip>

ูู ุญูู ุฃู ููุงุท ุชูุชูุด ุงูุชุฏุฑุฌ ูุฏ ุชุญุณู ููุงุกุฉ ุงูุฐุงูุฑุฉุ ุฅูุง ุฃููุง ุชุจุทุฆ ุงูุชุฏุฑูุจ ุจูุณุจุฉ 20%.

</Tip>

## ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท

**ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท** ูู ุชูููุฉ ุชูุฏู ุฅูู ุชุญุณูู ุงูููุงุกุฉ ุงูุญุณุงุจูุฉ ูุชุฏุฑูุจ ุงูููุงุฐุฌ ูู ุฎูุงู ุงุณุชุฎุฏุงู ุชูุณููุงุช ุฑูููุฉ ููุฎูุถุฉ ุงูุฏูุฉ ูุจุนุถ ุงููุชุบูุฑุงุช. ุชูููุฏููุงุ ุชุณุชุฎุฏู ูุนุธู ุงูููุงุฐุฌ ุฏูุฉ ุงูููุทุฉ ุงูุนุงุฆูุฉ 32 ุจุช (fp32 ุฃู float32) ูุชูุซูู ููุนุงูุฌุฉ ุงููุชุบูุฑุงุช. ููุน ุฐููุ ูุง ุชุญุชุงุฌ ุฌููุน ุงููุชุบูุฑุงุช ุฅูู ูุฐุง ุงููุณุชูู ุงูุนุงูู ูู ุงูุฏูุฉ ูุชุญููู ูุชุงุฆุฌ ุฏูููุฉ. ูู ุฎูุงู ุชูููู ุฏูุฉ ูุชุบูุฑุงุช ูุนููุฉ ุฅูู ุชูุณููุงุช ุฑูููุฉ ุฃููุ ูุซู ุงูููุทุฉ ุงูุนุงุฆูุฉ 16 ุจุช (fp16 ุฃู float16)ุ ูููููุง ุชุณุฑูุน ุงูุญุณุงุจุงุช. ูุธุฑูุง ูุฃู ุจุนุถ ุงูุญุณุงุจุงุช ุชุชู ูู ูุฐุง ุงูููุฌ ุจูุตู ุงูุฏูุฉุ ุจูููุง ูุง ุชุฒุงู ุจุนุถูุง ุงูุขุฎุฑ ุจุฏูุฉ ูุงููุฉุ ููุทูู ุนูู ุงูููุฌ ุงุณู ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท.

ูุชู ุชุญููู ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท ูู ูุนุธู ุงูุฃุญูุงู ุจุงุณุชุฎุฏุงู ุฃููุงุน ุจูุงูุงุช fp16 (float16)ุ ููุน ุฐููุ ุชููุฑ ุจุนุถ ุจููุงุช GPU (ูุซู ุจููุฉ Ampere) ุฃููุงุน ุจูุงูุงุช bf16 ูtf32 (ููุน ุจูุงูุงุช CUDA ุงูุฏุงุฎูู). ุชุญูู ูู [ูุฏููุฉ NVIDIA](https://developer.nvidia.com/blog/accelerating-ai-training-with-tf32-tensor-cores/) ููุนุฑูุฉ ุงููุฒูุฏ ุนู ุงูุงุฎุชูุงูุงุช ุจูู ุฃููุงุน ุงูุจูุงูุงุช ูุฐู.

### fp16

ุชุฃุชู ุงูููุฒุฉ ุงูุฑุฆูุณูุฉ ููุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท ูู ุญูุธ ุงูุชูุดูุทุงุช ุจูุตู ุงูุฏูุฉ (fp16). ุนูู ุงูุฑุบู ูู ุฃู ุงูุชุฏุฑุฌุงุช ูุชู ุญุณุงุจูุง ุฃูุถูุง ุจูุตู ุงูุฏูุฉุ ุฅูุง ุฃููุง ุชุชุญูู ูุฑุฉ ุฃุฎุฑู ุฅูู ุฏูุฉ ูุงููุฉ ูุฎุทูุฉ ุงูุชุญุณููุ ูุฐุง ูุง ูุชู ุชูููุฑ ุฃู ุฐุงูุฑุฉ ููุง.

ูู ุญูู ุฃู ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท ูุคุฏู ุฅูู ุญุณุงุจุงุช ุฃุณุฑุนุ ุฅูุง ุฃูู ูููู ุฃู ูุคุฏู ุฃูุถูุง ุฅูู ุงุณุชุฎุฏุงู ุงููุฒูุฏ ูู ุฐุงูุฑุฉ GPUุ ุฎุงุตุฉ ูุญุฌู ุงูุฏูุนุงุช ุงูุตุบูุฑุฉ. ููุฑุฌุน ุฐูู ุฅูู ูุฌูุฏ ุงููููุฐุฌ ุงูุขู ุนูู GPU ุจุฏูุฉ 16 ุจุช ู32 ุจุช (1.5x ูู ุงููููุฐุฌ ุงูุฃุตูู ุนูู GPU).

ูุชูููู ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุทุ ูู ุจุชุนููู ุงูุนูุงูุฉ `fp16` ุฅูู `True`:

```py
training_args = TrainingArguments(per_device_train_batch_size=4, fp16=True, **default_args)
```

ุฅุฐุง ููุช ุชูุถู ุงุณุชุฎุฏุงู ๐ค Accelerateุ ูุงุจุญุซ ุนู ูุซุงู ๐ค Accelerate [ูู ุงูุฃุณูู ูู ูุฐุง ุงูุฏููู](#using--accelerate). 

### BF16

ุฅุฐุง ูุงู ูุฏูู ุฅููุงููุฉ ุงููุตูู ุฅูู ุจููุฉ Ampere ุฃู ุฃุญุฏุซุ ูููููู ุงุณุชุฎุฏุงู bf16 ููุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท ูุงูุชูููู. ูู ุญูู ุฃู ุฏูุฉ bf16 ุฃุณูุฃ ูู fp16ุ ุฅูุง ุฃู ููุง ูุทุงู ุฏููุงูููู ุฃูุจุฑ. ูู fp16ุ ุฃูุจุฑ ุฑูู ูููู ุฃู ุชุญุตู ุนููู ูู `65535` ูุฃู ุฑูู ุฃุนูู ูู ุฐูู ุณูุคุฏู ุฅูู ููุถ. ูููู ุฃู ูููู ุฑูู bf16 ูุจูุฑูุง ูุซู `3.39e+38` (!) ููู ุชูุฑูุจูุง ููุณ fp32 - ูุฃู ูููููุง ูุณุชุฎุฏู 8 ุจุชุงุช ููุทุงู ุงูุฃุฑูุงู.

ููููู ุชูููู BF16 ูู ๐ค Trainer ุจุงุณุชุฎุฏุงู ูุง ููู:

```python
training_args = TrainingArguments(bf16=True, **default_args)
```

### TF32
ููููู ุชูููู BF16 ูู ๐ค Trainer ุจุงุณุชุฎุฏุงู ูุง ููู:

```python
training_args = TrainingArguments(bf16=True, **default_args)
```

### TF32

ุชุณุชุฎุฏู ุจููุฉ Ampere ููุน ุจูุงูุงุช ุณุญุฑู ูุณูู tf32. ููุฏูู ููุณ ุงููุทุงู ุงูุฑููู ูุซู fp32 (8 ุจุชุงุช)ุ ูููู ุจุฏูุงู ูู 23 ุจุช ูู ุงูุฏูุฉุ ูุฅูู ูุญุชูู ููุท ุนูู 10 ุจุชุงุช (ููุณ fp16) ููุณุชุฎุฏู 19 ุจุชูุง ููุท ูู ุงููุฌููุน. ุฅูู "ุณุญุฑู" ุจูุนูู ุฃูู ููููู ุงุณุชุฎุฏุงู ุฑูุฒ ุงูุชุฏุฑูุจ ู/ุฃู ุงูุงุณุชุฏูุงู fp32 ุงูุนุงุฏูุ ููู ุฎูุงู ุชูููู ุฏุนู tf32ุ ููููู ุงูุญุตูู ุนูู ุชุญุณู ูู ุงูุฅูุชุงุฌูุฉ ูุตู ุฅูู 3 ูุฑุงุช. ูู ูุง ุนููู ูุนูู ูู ุฅุถุงูุฉ ูุง ููู ุฅูู ุฑูุฒู:

```python
import torch
torch.backends.cuda.matmul.allow_tf32 = True
torch.backends.cudnn.allow_tf32 = True
```

ุณุชููู CUDA ุชููุงุฆููุง ุจุงูุชุจุฏูู ุฅูู ุงุณุชุฎุฏุงู tf32 ุจุฏูุงู ูู fp32 ุญูุซูุง ุฃููู ุฐููุ ุจุงูุชุฑุงุถ ุฃู GPU ุงููุณุชุฎุฏูุฉ ูู ูู ุณูุณูุฉ Ampere.

ููููุง ูู [ุจุญุซ NVIDIA](https://developer.nvidia.com/blog/accelerating-ai-training-with-tf32-tensor-cores/)ุ ูุฅู ุบุงูุจูุฉ ุฃุนุจุงุก ุนูู ุงูุชุฏุฑูุจ ุนูู ุงูุชุนูู ุงูุขูู ุชุธูุฑ ููุณ ุงูุบููุถ ูุงูุชูุงุฑุจ ูุน ุงูุชุฏุฑูุจ tf32 ููุง ูู ุงูุญุงู ูุน fp32. ุฅุฐุง ููุช ุชุณุชุฎุฏู ุจุงููุนู fp16 ุฃู bf16 ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุทุ ููุฏ ูุณุงุนุฏ ุฐูู ูู ุงูุฅูุชุงุฌูุฉ ุฃูุถูุง.

ููููู ุชูููู ูุฐุง ุงููุถุน ูู ๐ค Trainer:

```python
TrainingArguments(tf32=True, **default_args)
```

<Tip>

ูุง ูููู ุงููุตูู ุฅูู tf32 ูุจุงุดุฑุฉ ุนุจุฑ `tensor.to(dtype=torch.tf32)` ูุฃูู ููุน ุจูุงูุงุช ุฏุงุฎูู ูู CUDA. ุชุญุชุงุฌ ุฅูู `torch>=1.7` ูุงุณุชุฎุฏุงู ุฃููุงุน ุจูุงูุงุช tf32.

</Tip>

ููุญุตูู ุนูู ูุนูููุงุช ุฅุถุงููุฉ ุญูู tf32 ููุงุจู ุงูุฏูุฉ ุงูุฃุฎุฑูุ ูุฑุฌู ุงูุฑุฌูุน ุฅูู ุงููุนุงููุฑ ุงููุฑุฌุนูุฉ ุงูุชุงููุฉ: [RTX-3090](https://github.com/huggingface/transformers/issues/14608#issuecomment-1004390803) ู [A100](https://github.com/huggingface/transformers/issues/15026#issuecomment-1004543189).

## Flash Attention 2

ููููู ุชุณุฑูุน ุฅูุชุงุฌูุฉ ุงูุชุฏุฑูุจ ุจุงุณุชุฎุฏุงู ุชูุงูู Flash Attention 2 ูู ุงููุญููุงุช. ุชุญูู ูู ุงููุณู ุงูููุงุณุจ ูู [ูุณู GPU ุงููุฑุฏู](./perf_infer_gpu_one#Flash-Attention-2) ููุนุฑูุฉ ุงููุฒูุฏ ุญูู ููููุฉ ุชุญููู ูููุฐุฌ ุจุงุณุชุฎุฏุงู ูุญุฏุงุช Flash Attention 2. 

## ุงุฎุชูุงุฑ ุงููุญุณู

ุงููุญุณู ุงูุฃูุซุฑ ุงุณุชุฎุฏุงููุง ูุชุฏุฑูุจ ููุงุฐุฌ ุงููุญูู ูู Adam ุฃู AdamW (Adam ูุน ุงูุญูุงู ุงููุฒู). ูุญูู Adam ุชูุงุฑุจูุง ุฌูุฏูุง ุนู ุทุฑูู ุชุฎุฒูู ุงููุชูุณุท โโุงููุชุญุฑู ููุชุฏุฑุฌุงุช ุงูุณุงุจูุฉุ ููุน ุฐููุ ูุฅูู ูุถูู ุจุตูุฉ ุฐุงูุฑุฉ ุฅุถุงููุฉ ุจุญุฌู ุนุฏุฏ ูุนููุงุช ุงููููุฐุฌ. ููุนุงูุฌุฉ ุฐููุ ููููู ุงุณุชุฎุฏุงู ูุญุณู ุจุฏูู. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู [NVIDIA/apex](https://github.com/NVIDIA/apex) ูุซุจุชูุง ูู GPUs ูู NVIDIAุ ุฃู [ROCmSoftwarePlatform/apex](https://github.com/ROCmSoftwarePlatform/apex) ูู GPUs ูู AMDุ ูุณูููุญู `adamw_apex_fused` ุฃุณุฑุน ุชุฌุฑุจุฉ ุชุฏุฑูุจ ุจูู ุฌููุน ูุญุณูุงุช AdamW ุงููุฏุนููุฉ.

ูุชูุงูู [`Trainer`] ูุน ูุฌููุนุฉ ูุชููุนุฉ ูู ุงููุญุณูุงุช ุงูุชู ูููู ุงุณุชุฎุฏุงููุง ูุจุงุดุฑุฉ ูู ุงูุตูุฏูู: `adamw_hf`ุ `adamw_torch`ุ `adamw_torch_fused`ุ `adamw_apex_fused`ุ `adamw_anyprecision`ุ `adafactor`ุ ุฃู `adamw_bnb_8bit`. ูููู ุฅุถุงูุฉ ูุญุณูุงุช ุฃุฎุฑู ุนุจุฑ ุชูููุฐ ุชุงุจุน ุฎุงุฑุฌู.

ุฏุนููุง ูููู ูุธุฑุฉ ูุงุญุตุฉ ุนูู ุจุฏูููู ููุญุณู AdamW:

1. `adafactor` ุงููุชุงุญ ูู [`Trainer`]
2. `adamw_bnb_8bit` ูุชุงุญ ุฃูุถูุง ูู Trainerุ ูููู ูุชู ุชูููุฑ ุชูุงูู ุชุงุจุน ุฎุงุฑุฌู ุฃุฏูุงู ููุชูุถูุญ.

ูููุงุฑูุฉุ ููููุฐุฌ 3B-parameterุ ูุซู "google-t5/t5-3b": 

* ุณูู ูุญุชุงุฌ ูุญุณู AdamW ุงูููุงุณู ุฅูู 24 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ GPU ูุฃูู ูุณุชุฎุฏู 8 ุจุงูุชุงุช ููู ูุนููุฉ (8*3 => 24 ุฌูุฌุงุจุงูุช)
* ุณูู ูุญุชุงุฌ ูุญุณู Adafactor ุฅูู ุฃูุซุฑ ูู 12 ุฌูุฌุงุจุงูุช. ูุณุชุฎุฏู ุฃูุซุฑ ุจูููู ูู 4 ุจุงูุชุงุช ููู ูุนููุฉุ ูุฐุง 4*3 ูุจุนุถ ุงูุฅุถุงูุงุช.
* ุณูู ูุณุชุฎุฏู ูุญุณู 8bit BNB ุงูููุฏุฑุฌ 6 ุฌูุฌุงุจุงูุช ููุท ุฅุฐุง ุชู ุชูููู ุฌููุน ุญุงูุงุช ุงููุญุณู.

### Adafactor

ูุง ูููู Adafactor ุจุชุฎุฒูู ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ ููู ุนูุตุฑ ูู ูุตูููุงุช ุงูุฃูุฒุงู. ุจุฏูุงู ูู ุฐููุ ูุฅูู ูุญุชูุธ ุจุงููุนูููุงุช ุงููุฌูุนุฉ (ูุฌุงููุน ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ ุตููุง ูุนููุฏููุง)ุ ููุง ูููู ุจุดูู ูุจูุฑ ูู ุจุตูุชู. ููุน ุฐููุ ููุงุฑูุฉ ุจู Adamุ ูุฏ ูููู ูุฏู Adafactor ุชูุงุฑุจ ุฃุจุทุฃ ูู ุจุนุถ ุงูุญุงูุงุช.

ููููู ุงูุชุจุฏูู ุฅูู Adafactor ุนู ุทุฑูู ุชุนููู `optim="adafactor"` ูู [`TrainingArguments`]:

```py
training_args = TrainingArguments(per_device_train_batch_size=4, optim="adafactor"ุ **default_args)
```

ุจุงูุฌูุน ุจูู ุงููููุฌ ุงูุฃุฎุฑู (ุชุฌููุน ุงูุชุฏุฑุฌุงุชุ ูููุงุท ุชูุชูุด ุงูุชุฏุฑุฌุ ูุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท)ุ ููููู ููุงุญุธุฉ ุชุญุณู ูุตู ุฅูู 3 ูุฑุงุช ูุน ุงูุญูุงุธ ุนูู ุงูุฅูุชุงุฌูุฉ! ููุน ุฐููุ ููุง ุฐูุฑูุง ุณุงุจููุงุ ูุฏ ูููู ุชูุงุฑุจ Adafactor ุฃุณูุฃ ูู Adam. 

### Adam 8-ุจุช

ุจุฏูุงู ูู ุชุฌููุน ุญุงูุงุช ุงููุญุณู ูุซู Adafactorุ ูุญุชูุธ Adam 8-ุจุช ุจุงูุญุงูุฉ ุงููุงููุฉ ููููู ุจุชูููููุง. ูุนูู ุงูุชูููู ุฃูู ูุชู ุชุฎุฒูู ุงูุญุงูุฉ ุจุฏูุฉ ุฃูู ููุชู ุฅูุบุงุก ุชูููููุง ููุท ููุชุญุณูู. ูุฐุง ูุดุงุจู ูููุฑุฉ ุงูุชุฏุฑูุจ ุนุงูู ุงูุฏูุฉ ุงููุฎุชูุท.

ูุงุณุชุฎุฏุงู `adamw_bnb_8bit`ุ ูุง ุนููู ุณูู ุชุนููู `optim="adamw_bnb_8bit"` ูู [`TrainingArguments`]:

```py
training_args = TrainingArguments(per_device_train_batch_size=4, optim="adamw_bnb_8bit"ุ **default_args)
```

ููุน ุฐููุ ูููููุง ุฃูุถูุง ุงุณุชุฎุฏุงู ุชูููุฐ ุชุงุจุน ุฎุงุฑุฌู ููุญุณู 8 ุจุช ููุชูุถูุญ.

ุฃููุงูุ ุงุชุจุน ุฏููู ุงูุชุซุจูุช ูู ูุณุชูุฏุน [GitHub](https://github.com/TimDettmers/bitsandbytes) ูุชุซุจูุช ููุชุจุฉ `bitsandbytes` ุงูุชู ุชููุฐ ูุญุณู Adam 8 ุจุช.

ุจุนุฏ ุฐููุ ุชุญุชุงุฌ ุฅูู ุชููุฆุฉ ุงููุญุณู. ููุทูู ุฐูู ุนูู ุฎุทูุชูู:

* ุฃููุงูุ ูู ุจุชูุณูู ูุนููุงุช ุงููููุฐุฌ ุฅูู ูุฌููุนุชูู - ูุงุญุฏุฉ ูุชู ุชุทุจูู ุงูุญูุงู ุงููุฒู ุนูููุงุ ูุงูุฃุฎุฑู ูุง ูุชู ุชุทุจููู ุนูููุง. ุนุงุฏุฉู ูุง ูุชู ุชุทุจูู ุงูุญูุงู ุงููุฒู ุนูู ูุนููุงุช ุงูุชุญูุฒ ููุนููุงุช ุทุจูุฉ ุงูุชุทุจูุน.
* ุซู ูู ุจุชูุธูู ูุณูุทุงุช ุงููุญุณู ูุงุณุชุฎุฏุงู ููุณ ุงููุนููุงุช ูุซู ูุญุณู AdamW ุงููุณุชุฎุฏู ุณุงุจููุง.

```py
import bitsandbytes as bnb
from torch import nn
from transformers.trainer_pt_utils import get_parameter_names

training_args = TrainingArguments(per_device_train_batch_size=4, **default_args)

decay_parameters = get_parameter_names(model, [nn.LayerNorm])
decay_parameters = [name for name in decay_parameters if "bias" not in name]
optimizer_grouped_parameters = [
    {
        "params": [p for n, p in model.named_parameters() if n in decay_parameters],
        "weight_decay": training_args.weight_decay,
    },
    {
        "params": [p for n, p in model.named_parameters() if n not in decay_parameters],
        "weight_decay": 0.0,
    },
]

optimizer_kwargs = {
    "betas": (training_args.adam_beta1, training_args.adam_beta2),
    "eps": training_args.adam_epsilon,
}
optimizer_kwargs["lr"] = training_args.learning_rate
adam_bnb_optim = bnb.optim.Adam8bit(
    optimizer_grouped_parameters,
    betas=(training_args.adam_beta1, training_args.adam_beta2),
    eps=training_args.adam_epsilon,
    lr=training_args.learning_rate,
)
```
ุฃุฎูุฑูุงุ ูู ุจุชูุฑูุฑ ุงููุญุณู ุงููุฎุตุต ูุญุฌุฉ ุฅูู "Trainer":

```py
trainer = Trainer(model=model, args=training_args, train_dataset=ds, optimizers=(adam_bnb_optim, None))
```

ุจุงูุฌูุน ุจูู ูุฐุง ุงูููุฌ ูููุฌ ุฃุฎุฑู (ุชุฌููุน ุงูุฎุฑุฌุงุชุ ูุญูุธ ููุงุท ุงูุชูุชูุด ููุฎุฑุฌุงุชุ ูุงูุชุฏุฑูุจ ุนูู ุงูุฏูุฉ ุงููุฎุชูุทุฉ)ุ ููููู ุชููุน ุชุญุณู ูู ุงูุฐุงูุฑุฉ ุจุญูุงูู 3 ูุฑุงุชุ ูุญุชู ุฒูุงุฏุฉ ุทูููุฉ ูู ุงูุฅูุชุงุฌูุฉ ููุงุฑูุฉ ุจุงุณุชุฎุฏุงู Adafactor.

### multi_tensor

ูุฏู pytorch-nightly `torch.optim._multi_tensor` ุงูุฐู ูุฌุจ ุฃู ูุณุฑุน ุจุดูู ูุจูุฑ ุงููุญุณูุงุช ูู ุงูุญุงูุงุช ุงูุชู ุชุญุชูู ุนูู ุงูุนุฏูุฏ ูู ุชูุณููุงุช ุงูููุฒุงุช ุงูุตุบูุฑุฉ. ููู ุงููุชููุน ุฃู ูุตุจุญ ูู ุงููุถุน ุงูุงูุชุฑุงุถูุ ูููู ุฅุฐุง ููุช ุชุฑูุฏ ุชุฌุฑุจุชู ูู ููุช ุฃูุฑุจุ ูุฑุงุฌุน ูุดููุฉ GitHub [ูุฐู](https://github.com/huggingface/transformers/issues/9965).

## ุงูุชุญููู ุงููุณุจู ููุจูุงูุงุช

ุฃุญุฏ ุงููุชุทูุจุงุช ุงููููุฉ ูููุตูู ุฅูู ุณุฑุนุฉ ุชุฏุฑูุจ ุนุงููุฉ ูู ุงููุฏุฑุฉ ุนูู ุชุบุฐูุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุจุฃูุตู ุณุฑุนุฉ ูููููุง ุงูุชุนุงูู ูุนูุง. ุจุดูู ุงูุชุฑุงุถูุ ูุญุฏุซ ูู ุดูุก ูู ุงูุนูููุฉ ุงูุฑุฆูุณูุฉุ ููุฏ ูุง ุชุชููู ูู ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ุงููุฑุต ุจุณุฑุนุฉ ูุงููุฉุ ููุง ูุคุฏู ุฅูู ุงุฎุชูุงูุ ููุง ูุคุฏู ุฅูู ุงูุงุณุชุฎุฏุงู ุงููุงูุต ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU). ูู ุจุชูููู ุงูุญุฌุฌ ุงูุชุงููุฉ ูุชูููู ุงูุงุฎุชูุงู:

- `DataLoader(pin_memory=True, ...)` - ูุถูู ุชุญููู ุงูุจูุงูุงุช ูุณุจููุง ูู ุงูุฐุงูุฑุฉ ุงููุซุจุชุฉ ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU) ูุนุงุฏุฉ ูุง ูุคุฏู ุฅูู ููู ุฃุณุฑุน ุจูุซูุฑ ูู ุฐุงูุฑุฉ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU) ุฅูู ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU).
- `DataLoader(num_workers=4, ...)` - ูู ุจุชุดุบูู ุงูุนุฏูุฏ ูู ุงูุนูุงู ูุชุญููู ุงูุจูุงูุงุช ุจุดูู ุฃุณุฑุน. ุฃุซูุงุก ุงูุชุฏุฑูุจุ ุฑุงูุจ ุฅุญุตุงุฆูุงุช ุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU)ุ ุฅุฐุง ูุงู ุฃูู ูู 100%ุ ูุฌุฑูุจ ุฒูุงุฏุฉ ุนุฏุฏ ุงูุนูุงู. ุจุงูุทุจุนุ ูุฏ ุชููู ุงููุดููุฉ ูู ููุงู ุขุฎุฑุ ูุฐุง ูุฅู ุงูุนุฏูุฏ ูู ุงูุนูุงู ูู ูุคุฏู ุจุงูุถุฑูุฑุฉ ุฅูู ุฃุฏุงุก ุฃูุถู.

ุนูุฏ ุงุณุชุฎุฏุงู [`Trainer`]ุ ุชููู ุงูุญุฌุฌ ุงูููุงุจูุฉ [`TrainingArguments`] ูู: `dataloader_pin_memory` (`True` ุจุดูู ุงูุชุฑุงุถู)ุ ู`dataloader_num_workers` (ุงูุชุฑุงุถููุง `0`).

## DeepSpeed ZeRO

DeepSpeed ูู ููุชุจุฉ ุชุญุณูู ููุชุนูู ุงูุนููู ููุชูุญุฉ ุงููุตุฏุฑ ูุฏูุฌุฉ ูู ๐ค Transformers ู ๐ค Accelerate. ููู ูููุฑ ูุฌููุนุฉ ูุงุณุนุฉ ูู ุงูููุฒุงุช ูุงูุชุญุณููุงุช ุงููุตููุฉ ูุชุญุณูู ููุงุกุฉ ููุงุจููุฉ ุชูุณุน ุงูุชุฏุฑูุจ ุนูู ุงูุชุนูู ุงูุนููู ูุงุณุน ุงููุทุงู.

ุฅุฐุง ูุงู ูููุฐุฌู ููุงุณุจ ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ูุงุญุฏุฉ ููุฏูู ูุณุงุญุฉ ูุงููุฉ ูุชูุงุณุจ ุญุฌู ุฏูุนุฉ ุตุบูุฑุ ููุง ุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู DeepSpeed ูุฃูู ุณูุจุทุฆ ุงูุฃููุฑ ููุท. ููุน ุฐููุ ุฅุฐุง ูู ููุงุณุจ ุงููููุฐุฌ ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ูุงุญุฏุฉ ุฃู ูุง ููููู ุชูุงุณุจ ุญุฌู ุฏูุนุฉ ุตุบูุฑุ ูููููู ุงูุงุณุชูุงุฏุฉ ูู DeepSpeed ZeRO + CPU Offloadุ ุฃู NVMe Offload ููููุงุฐุฌ ุงูุฃูุจุฑ ุจูุซูุฑ. ูู ูุฐู ุงูุญุงูุฉุ ุชุญุชุงุฌ ุฅูู [ุชุซุจูุช ุงูููุชุจุฉ](main_classes/deepspeed#installation) ุจุดูู ูููุตูุ ุซู ุงุชุจุน ุฃุญุฏ ุงูุฃุฏูุฉ ูุฅูุดุงุก ููู ุชูููู ูุชุดุบูู DeepSpeed:

* ููุญุตูู ุนูู ุฏููู ูุชุนูู ุญูู ุชูุงูู DeepSpeed ูุน [`Trainer`]ุ ุฑุงุฌุน [ุงูุชูุซูู ุงูููุงุจู](main_classes/deepspeed)ุ ูุชุญุฏูุฏูุง [ุงููุณู ุงูุฎุงุต ุจูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ูุงุญุฏุฉ](main_classes/deepspeed#deployment-with-one-gpu). ูุทููุจ ุจุนุถ ุงูุชุนุฏููุงุช ูุงุณุชุฎุฏุงู DeepSpeed ูู ุฏูุชุฑ ููุงุญุธุงุชุ ูุฑุฌู ุฅููุงุก ูุธุฑุฉ ุนูู [ุงูุฏููู ุงูููุงุจู](main_classes/deepspeed#deployment-in-notebooks).
* ุฅุฐุง ููุช ุชูุถู ุงุณุชุฎุฏุงู ๐ค Accelerateุ ูุฑุฌู ุงูุฑุฌูุน ุฅูู [ุฏููู DeepSpeed ูู ๐ค Accelerate](https://huggingface.co/docs/accelerate/en/usage_guides/deepspeed).

## ุงุณุชุฎุฏุงู torch.compile

ูุฏู PyTorch 2.0 ุฏุงูุฉ ุชุฌููุน ุฌุฏูุฏุฉ ูุง ุชุชุทูุจ ุฃู ุชุนุฏูู ุนูู ุชุนูููุงุช PyTorch ุงูุจุฑูุฌูุฉ ุงูุญุงููุฉ ูููู ูููููุง ุชุญุณูู ุชุนูููุงุช PyTorch ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจู ุนู ุทุฑูู ุฅุถุงูุฉ ุณุทุฑ ูุงุญุฏ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ: `model = torch.compile(model)`.

ุฅุฐุง ููุช ุชุณุชุฎุฏู [`Trainer`]ุ ููุฌุจ ุนููู ููุท ุชูุฑูุฑ `to` ุฎูุงุฑ `torch_compile` ูู [`TrainingArguments`]:

```python
training_args = TrainingArguments(torch_compile=True, **default_args)
```

ูุณุชุฎุฏู `torch.compile` ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุชูููู ุงูุฅุทุงุฑ ูู Python ูุฅูุดุงุก ุฑุณู ุจูุงูู ุชููุงุฆููุง ูู ุจุฑุงูุฌ PyTorch ุงูููุฌูุฏุฉ. ุจุนุฏ ุงูุชูุงุท ุงูุฑุณู ุงูุจูุงููุ ูููู ูุดุฑ backends ูุฎุชููุฉ ูุฎูุถ ุงูุฑุณู ุงูุจูุงูู ุฅูู ูุญุฑู ูุญุณูู. ููููู ุงูุนุซูุฑ ุนูู ูุฒูุฏ ูู ุงูุชูุงุตูู ูุงูุงุฎุชุจุงุฑุงุช ุงููุนูุงุฑูุฉ ูู [ูุซุงุฆู PyTorch](https://pytorch.org/get-started/pytorch-2.0/).

ูุฏู `torch.compile` ูุงุฆูุฉ ูุชุฒุงูุฏุฉ ูู backendsุ ูุงูุชู ูููู ุงูุนุซูุฑ ุนูููุง ุนู ุทุฑูู ุงุณุชุฏุนุงุก `torchdynamo.list_backends()`ุ ููู ูููุง ุชุจุนูุงุชู ุงูุงุฎุชูุงุฑูุฉ.

ุญุฏุฏ backend ุงูุฐู ุณูุชู ุงุณุชุฎุฏุงูู ุนู ุทุฑูู ุชุญุฏูุฏู ุนุจุฑ `torch_compile_backend` ูู [`TrainingArguments`]. ุจุนุถ backends ุงูุฃูุซุฑ ุงุณุชุฎุฏุงููุง ูู:

**backends ุงูุชุตุญูุญ**:
* `dynamo.optimize("eager")` - ูุณุชุฎุฏู PyTorch ูุชุดุบูู GraphModule ุงููุณุชุฎุฑุฌ. ูุฐุง ูููุฏ ุฌุฏูุง ูู ุชุตุญูุญ ูุดููุงุช TorchDynamo.
* `dynamo.optimize("aot_eager")` - ูุณุชุฎุฏู AotAutograd ุจุฏูู ูุชุฑุฌูุ ุฃู ูุฌุฑุฏ ุงุณุชุฎุฏุงู PyTorch eager ูุฑุณูู forward ูbackward ูู AotAutograd. ูุฐุง ูููุฏ ููุชุตุญูุญุ ููู ุบูุฑ ุงููุฑุฌุญ ุฃู ูููุฑ ุชุณุฑูุนูุง.

**backends ุงูุชุฏุฑูุจ ูุงูุงุณุชุฏูุงู**:
* `dynamo.optimize("inductor")` - ูุณุชุฎุฏู backend TorchInductor ูุน AotAutograd ูcudagraphs ุนู ุทุฑูู ุงูุงุณุชูุงุฏุฉ ูู ููุงุฉ Triton codegened [ุงูุฑุฃ ุงููุฒูุฏ](https://dev-discuss.pytorch.org/t/torchinductor-a-pytorch-native-compiler-with-define-by-run-ir-and-symbolic-shapes/747)
* `dynamo.optimize("nvfuser")` - nvFuser ูุน TorchScript. [ุงูุฑุฃ ุงููุฒูุฏ](https://dev-discuss.pytorch.org/t/tracing-with-primitives-update-1-nvfuser-and-its-primitives/593)
* `dynamo.optimize("aot_nvfuser")` - nvFuser ูุน AotAutograd. [ุงูุฑุฃ ุงููุฒูุฏ](https://dev-discuss.pytorch.org/t/tracing-with-primitives-update-1-nvfuser-and-its-primitives/593)
* `dynamo.optimize("aot_cudagraphs")` - cudagraphs ูุน AotAutograd. [ุงูุฑุฃ ุงููุฒูุฏ](https://github.com/pytorch/torchdynamo/pull/757)

**backends ุงูุงุณุชุฏูุงู ููุท**:
* `dynamo.optimize("ofi")` - ูุณุชุฎุฏู Torchscript optimize_for_inference. [ุงูุฑุฃ ุงููุฒูุฏ](https://pytorch.org/docs/stable/generated/torch.jit.optimize_for_inference.html)
* `dynamo.optimize("fx2trt")` - ูุณุชุฎุฏู NVIDIA TensorRT ูุชุญุณูู ุงูุงุณุชุฏูุงู. [ุงูุฑุฃ ุงููุฒูุฏ](https://pytorch.org/TensorRT/tutorials/getting_started_with_fx_path.html)
* `dynamo.optimize("onnxrt")` - ูุณุชุฎุฏู ONNXRT ููุงุณุชุฏูุงู ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU) / ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU). [ุงูุฑุฃ ุงููุฒูุฏ](https://onnxruntime.ai/)
* `dynamo.optimize("ipex")` - ูุณุชุฎุฏู IPEX ููุงุณุชุฏูุงู ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU). [ุงูุฑุฃ ุงููุฒูุฏ](https://github.com/intel/intel-extension-for-pytorch)

ููุซุงู ุนูู ุงุณุชุฎุฏุงู `torch.compile` ูุน ๐ค Transformersุ ุชุญูู ูู [ููุดูุฑ ุงููุฏููุฉ ุญูู ุถุจุท ูููุฐุฌ BERT ุงูุฏููู ูุชุตููู ุงููุตูุต ุจุงุณุชุฎุฏุงู ุฃุญุฏุซ ููุฒุงุช PyTorch 2.0](https://www.philschmid.de/getting-started-pytorch-2-0-transformers)

## ุงุณุชุฎุฏุงู PEFT (ุถุจุท ุฏููู ูุนุงู ูู ุญูุซ ุงูุชูููุฉ)

ุชููู ุทุฑู [ุถุจุท ุฏููู ูุนุงู ูู ุญูุซ ุงูุชูููุฉ ูููุนููุงุช](https://huggingface.co/blog/peft) ุจุชุฌููุฏ ูุนููุงุช ุงููููุฐุฌ ุงูููุฏุฑุจ ูุณุจููุง ุฃุซูุงุก ุงูุถุจุท ุงูุฏููู ูุฅุถุงูุฉ ุนุฏุฏ ุตุบูุฑ ูู ุงููุนููุงุช ุงููุงุจูุฉ ููุชุฏุฑูุจ (ุงูููุงูุฆุงุช) ูููู.

ููุชูุฌุฉ ูุฐููุ ูุชู ุชูููู [ุงูุฐุงูุฑุฉ ุงููุฑุชุจุทุฉ ุจุญุงูุงุช ุงูููุญุณู ูุงูุชุฏุฑุฌุงุช](https://huggingface.co/docs/transformers/model_memory_anatomy#anatomy-of-models-memory) ุจุดูู ูุจูุฑ.

ุนูู ุณุจูู ุงููุซุงูุ ุจุงุณุชุฎุฏุงู AdamW ุงููุงูููุงุ ุณูููู ูุชุทูุจ ุงูุฐุงูุฑุฉ ูุญุงูุฉ ุงูููุญุณู ููุง ููู:

- ูุณุฎุฉ fp32 ูู ุงููุนููุงุช: 4 ุจุงูุช/ูุนููุฉ
- ุงูุฒุฎู: 4 ุจุงูุช/ูุนููุฉ
- ุงูุชุจุงูู: 4 ุจุงูุช/ูุนููุฉ

ูููุชุฑุถ ุฃู ูุฏููุง ูููุฐุฌูุง ุจู 7 ูููุงุฑุงุช ูุนููุฉ ู200 ููููู ูุนููุฉ ุชู ุญูููุง ุจุงุณุชุฎุฏุงู [ูุญููุงุช ุงูุชุฑุชูุจ ุงูููุฎูุถ](https://huggingface.co/docs/peft/conceptual_guides/lora).

ุณูููู ูุชุทูุจ ุงูุฐุงูุฑุฉ ูุญุงูุฉ ุงูููุญุณู ูููููุฐุฌ ุงูุนุงุฏู 12 * 7 = 84 ุฌูุฌุงุจุงูุช (ุจุงูุชุฑุงุถ 7 ูููุงุฑุงุช ูุนููุฉ ูุงุจูุฉ ููุชุฏุฑูุจ).

ุชุคุฏู ุฅุถุงูุฉ Lora ุฅูู ุฒูุงุฏุฉ ุทูููุฉ ูู ุงูุฐุงูุฑุฉ ุงููุฑุชุจุทุฉ ุจุฃูุฒุงู ุงููููุฐุฌ ูุชูููู ูุชุทูุจุงุช ุงูุฐุงูุฑุฉ ูุญุงูุฉ ุงูููุญุณู ุจุดูู ูุจูุฑ ุฅูู 12 * 0.2 = 2.4 ุฌูุฌุงุจุงูุช.

ููุนุฑูุฉ ุงููุฒูุฏ ุญูู PEFT ูุงุณุชุฎุฏุงูู ุงูููุตูุ ุฑุงุฌุน [ูุซุงุฆู PEFT](https://huggingface.co/docs/peft/) ุฃู [ูุณุชูุฏุน PEFT](https://github.com/huggingface/peft).

## ุงุณุชุฎุฏุงู ๐ค Accelerate

ูุน [๐ค Accelerate](https://huggingface.co/docs/accelerate/index)ุ ููููู ุงุณุชุฎุฏุงู ุงูุทุฑู ุงููุฐููุฑุฉ ุฃุนูุงู ูุน ุงูุชุญูู ุงููุงูู ูู ุญููุฉ ุงูุชุฏุฑูุจุ ูููููู ุฃุณุงุณููุง ูุชุงุจุฉ ุงูุญููุฉ ูู PyTorch ุงูููู ูุน ุจุนุถ ุงูุชุนุฏููุงุช ุงูุทูููุฉ.

ูููุชุฑุถ ุฃูู ููุช ุจุฏูุฌ ุงูุทุฑู ูู [`TrainingArguments`] ููุง ููู:

```py
training_args = TrainingArguments(
    per_device_train_batch_size=1,
    gradient_accumulation_steps=4,
    gradient_checkpointing=True,
    fp16=True,
    **default_args,
)
```

ุชุชููู ุญููุฉ ุงูุชุฏุฑูุจ ุงููุงููุฉ ุจุงุณุชุฎุฏุงู ๐ค Accelerate ูู ุจุถุน ุฃุณุทุฑ ููุท ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ:

```py
from accelerate import Accelerator
from torch.utils.data.dataloader import DataLoader

dataloader = DataLoader(ds, batch_size=training_args.per_device_train_batch_size)

if training_args.gradient_checkpointing:
    model.gradient_checkpointing_enable()

accelerator = Accelerator(fp16=training_args.fp16)
model, optimizer, dataloader = accelerator.prepare(model, adam_bnb_optim, dataloader)
accelerator = Accelerator(fp16=training_args.fp16)
model, optimizer, dataloader = accelerator.prepare(model, adam_bnb_optim, dataloader)

model.train()
for step, batch in enumerate(dataloader, start=1):
    loss = model(**batch).loss
    loss = loss / training_args.gradient_accumulation_steps
    accelerator.backward(loss)
    if step % training_args.gradient_accumulation_steps == 0:
        optimizer.step()
        optimizer.zero_grad()
```

ุฃููุงูุ ูููู ุจุชุบููู ูุฌููุนุฉ ุงูุจูุงูุงุช ูู [`DataLoader`](https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader).
ุจุนุฏ ุฐููุ ูููููุง ุชูููู ุงูุชุญูู ูู ุงูุชุฏุฑุฌ ุนู ุทุฑูู ุงุณุชุฏุนุงุก ุทุฑููุฉ [`~PreTrainedModel.gradient_checkpointing_enable`] ูููููุฐุฌ.
ุนูุฏ ุชููุฆุฉ [`Accelerator`](https://huggingface.co/docs/accelerate/package_reference/accelerator#accelerate.Accelerator)ุ
ูููููุง ุชุญุฏูุฏ ูุง ุฅุฐุง ููุง ูุฑูุฏ ุงุณุชุฎุฏุงู ุงูุชุฏุฑูุจ ุจุงูุฏูุฉ ุงููุฎุชูุทุฉุ ูุณูุชููู ุงูุฃูุฑ ููุงุจุฉ ุนูุง ูู ููุงููุฉ [`prepare`].
ุฃุซูุงุก ููุงููุฉ [`prepare`](https://huggingface.co/docs/accelerate/package_reference/accelerator#accelerate.Accelerator.prepare)ุ
ุณูุชู ุฃูุถูุง ุชูุฒูุน ุจุฑูุงูุฌ ุงูุชุบุฐูุฉ ุงูุชููุงุฆูุฉ ุนุจุฑ ุงูุนูุงู ูู ุญุงูุฉ ุงุณุชุฎุฏุงู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ูุชุนุฏุฏุฉ. ูุณุชุฎุฏู ููุณ [ูุญุณู 8 ุจุช](#8-bit-adam) ูู ุงููุซุงู ุงูุณุงุจู.

ุฃุฎูุฑูุงุ ูููููุง ุฅุถุงูุฉ ุญููุฉ ุงูุชุฏุฑูุจ ุงูุฑุฆูุณูุฉ. ูุงุญุธ ุฃู ููุงููุฉ `backward` ุชุชู ูู ุฎูุงู ๐ค Accelerate. ูููููุง ุฃูุถูุง ุฃู ูุฑู
ููู ูุนูู ุชุฑุงูู ุงูุชุฏุฑุฌุงุช: ูููู ุจุชุทุจูุน ุงูุฎุณุงุฑุฉุ ูุฐูู ูุญุตู ุนูู ุงููุชูุณุท ูู ููุงูุฉ ุงูุชุฑุงูู ูุจูุฌุฑุฏ ุฃู ูููู ูุฏููุง
ุฎุทูุงุช ูุงููุฉุ ูููู ุจุชุดุบูู ุงูุชุญุณูู.

ูุง ูุชุทูุจ ุชูููุฐ ุชูููุงุช ุงูุชุญุณูู ูุฐู ุจุงุณุชุฎุฏุงู ๐ค Accelerate ุณูู ุจุถุน ุฃุณุทุฑ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูุชุฃุชู ุจููุฒุฉ ุงููุฑููุฉ ูู ุญููุฉ ุงูุชุฏุฑูุจ. ููุญุตูู ุนูู ูุซุงุฆู ูุงููุฉ ูุฌููุน ุงูููุฒุงุชุ ุฑุงุฌุน [ูุซุงุฆู Accelerate](https://huggingface.co/docs/accelerate/index).

## ุงูุจุฑุงูุฌ ุงููุนุงูุฉ ูุณุจูุฉ ุงูุจูุงุก

ุชุฃุชู ุฅุตุฏุงุฑุงุช PyTorch [pip ูconda](https://pytorch.org/get-started/locally/#start-locally) ููุฌูููุนุฉ ูุณุจููุง ูุน ุญุฒูุฉ CUDA toolkit
ุงูุชู ุชููู ูุงููุฉ ูุชุดุบูู PyTorchุ ูููููุง ุบูุฑ ูุงููุฉ ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุฅูุดุงุก ููุญูุงุช CUDA.

ูู ุจุนุถ ุงูุฃุญูุงูุ ูุฏ ุชููู ููุงู ุญุงุฌุฉ ุฅูู ุจุฐู ุฌููุฏ ุฅุถุงููุฉ ูุจูุงุก ุจุนุถ ุงูููููุงุช ูุณุจููุง. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ููุช ุชุณุชุฎุฏู ููุชุจุงุช ูุซู `apex` ุงูุชู
ูุง ุชุฃุชู ูุฌูุนุฉ ูุณุจููุง. ูู ููุงูู ุฃุฎุฑูุ ูุฏ ูููู ูู ุงูุตุนุจ ูุนุฑูุฉ ููููุฉ ุชุซุจูุช ุญุฒูุฉ CUDA toolkit ุนูู ูุณุชูู ุงููุธุงู.
ููุนุงูุฌุฉ ูุฐู ุงูุณููุงุฑูููุงุชุ ุฃุตุฏุฑุช PyTorch ูNVIDIA ุฅุตุฏุงุฑูุง ุฌุฏูุฏูุง ูู ุญุงููุฉ NGC docker ุงูุชู ุชุฃุชู ุจุงููุนู ูุน
ูู ุดูุก ููุฌูููุน ูุณุจููุง. ูุง ุนููู ุณูู ุชุซุจูุช ุจุฑุงูุฌู ุนูููุ ูุณูุนูู ุนูู ุงูููุฑ.

ูุฐุง ุงูููุฌ ูููุฏ ุฃูุถูุง ุฅุฐุง ููุช ุชุฑูุฏ ุถุจุท ูุตุฏุฑ pytorch ู/ุฃู ุฅุฌุฑุงุก ุจูุงุก ูุฎุตุต ุฌุฏูุฏ.
ูุนุซูุฑ ุนูู ุฅุตุฏุงุฑ ุตูุฑุฉ docker ุงูุฐู ุชุฑูุฏูุ ุงุจุฏุฃ [ุจููุงุญุธุงุช ุฅุตุฏุงุฑ PyTorch](https://docs.nvidia.com/deeplearning/frameworks/pytorch-release-notes/)ุ
ูุงุฎุชุฑ ุฃุญุฏุซ ุงูุฅุตุฏุงุฑุงุช ุงูุดูุฑูุฉ. ุงูุชูู ุฅูู ููุงุญุธุงุช ุงูุฅุตุฏุงุฑ ูููุณุฎุฉ ุงููุทููุจุฉุ ูุชุญูู ูู ุฃู ููููุงุช ุงูุจูุฆุฉ ุชุชุทุงุจู ูุน ุงุญุชูุงุฌุงุชู (ุจูุง ูู ุฐูู ูุชุทูุจุงุช ุจุฑูุงูุฌ ุชุดุบูู NVIDIA!) ุซู ูู ุฃุนูู ุชูู ุงููุซููุฉุ ุงูุชูู
ุฅูู ุตูุญุฉ NGC ุงูููุงุจูุฉ. ุฅุฐุง ุถููุช ุงูุทุฑูู ูุณุจุจ ูุงุ ููุฐุง ูู [ููุฑุณ ุฌููุน ุตูุฑ NGC PyTorch](https://ngc.nvidia.com/catalog/containers/nvidia:pytorch).

ุจุนุฏ ุฐููุ ุงุชุจุน ุงูุชุนูููุงุช ูุชูุฒูู ุตูุฑุฉ docker ููุดุฑูุง.

## ูุฒูุฌ ูู ุงูุฎุจุฑุงุก

ุฃุจูุบุช ุจุนุถ ุงูุฃูุฑุงู ุงูุจุญุซูุฉ ุงูุญุฏูุซุฉ ุนู ุฒูุงุฏุฉ ุณุฑุนุฉ ุงูุชุฏุฑูุจ ุจููุฏุงุฑ 4-5 ูุฑุงุช ูุฒูุงุฏุฉ ุณุฑุนุฉ ุงูุงุณุชุฏูุงู ุนู ุทุฑูู ุฏูุฌ
ูุฒูุฌ ูู ุงูุฎุจุฑุงุก (MoE) ูู ููุงุฐุฌ ุงููุญูู.

ูุธุฑูุง ูุงูุชุดุงู ุฃู ุงููุฒูุฏ ูู ุงููุนููุงุช ูุคุฏู ุฅูู ุฃุฏุงุก ุฃูุถูุ ุชุณูุญ ูุฐู ุงูุชูููุฉ ุจุฒูุงุฏุฉ
ุนุฏุฏ ุงููุนููุงุช ุจููุฏุงุฑ ุฏุฑุฌุฉ ุฏูู ุฒูุงุฏุฉ ุชูุงููู ุงูุชุฏุฑูุจ.

ูู ูุฐุง ุงูููุฌุ ูุชู ุงุณุชุจุฏุงู ูู ุทุจูุฉ ุดุจูุฉ ุนุตุจูุฉ ุงุตุทูุงุนูุฉ ุฃุฎุฑู ุจุทุจูุฉ MoE ุชุชููู ูู ุงูุนุฏูุฏ ูู ุงูุฎุจุฑุงุกุ ูุน ุฏุงูุฉ ุจูุงุจุฉ
ุชุฏุฑุจ ูู ุฎุจูุฑ ุจุทุฑููุฉ ูุชูุงุฒูุฉ ุงุนุชูุงุฏูุง ุนูู ููุถุน ุฑูุฒ ุงูุฅุฏุฎุงู ูู ุชุณูุณู.
![ูุญูู MoE 2x block](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/perf-moe-transformer.png)

(ุงููุตุฏุฑ: [GLAM](https://ai.googleblog.com/2021/12/more-efficient-in-context-learning-with.html))

ููููู ุงูุนุซูุฑ ุนูู ุชูุงุตูู ุดุงููุฉ ูุฌุฏุงูู ููุงุฑูุฉ ูู ุงูุฃูุฑุงู ุงูุจุญุซูุฉ ุงููุฏุฑุฌุฉ ูู ููุงูุฉ ูุฐุง ุงููุณู.

ุงูุฌุงูุจ ุงูุณูุจู ุงูุฑุฆูุณู ููุฐุง ุงูููุฌ ูู ุฃูู ูุชุทูุจ ูููุงุช ูุงุฆูุฉ ูู ุฐุงูุฑุฉ GPU - ุฃูุจุฑ ุจุญูุงูู ุฏุฑุฌุฉ ูู ููุงูุฆูุง ุงููุซูู. ุชู ุงูุชุฑุงุญ ุชูุทูุฑ ูููุฌ ูุฎุชููุฉ ููุชุบูุจ ุนูู ูุชุทูุจุงุช ุงูุฐุงูุฑุฉ ุงูุฃุนูู ุจูุซูุฑ.

ููุงู ููุงูุถุฉ ูุจุงุดุฑุฉุ ูููููู ุงุณุชุฎุฏุงู ุนุฏุฏ ูููู ูู ุงูุฎุจุฑุงุก ูุน ูููุฐุฌ ุฃุณุงุณู ุฃุตุบุฑ ุจููุฏุงุฑ 2-3 ูุฑุงุช ุจุฏูุงู ูู ุนุดุฑุงุช ุฃู
ูุฆุงุช ุงูุฎุจุฑุงุก ููุง ูุคุฏู ุฅูู ูููุฐุฌ ุฃุตุบุฑ ุจููุฏุงุฑ 5 ูุฑุงุช ูุจุงูุชุงูู ุฒูุงุฏุฉ ุณุฑุนุฉ ุงูุชุฏุฑูุจ ุจุดูู ูุนุชุฏู ูุน ุฒูุงุฏุฉ
ูุชุทูุจุงุช ุงูุฐุงูุฑุฉ ุจุดูู ูุนุชุฏู ุฃูุถูุง.

ุชู ุจูุงุก ูุนุธู ุงูุฃูุฑุงู ุงูุจุญุซูุฉ ูุงูุชูููุฐุงุช ุฐุงุช ุงูุตูุฉ ุญูู Tensorflow/TPUs:

- [GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding](https://arxiv.org/abs/2006.16668)
- [Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity](https://arxiv.org/abs/2101.03961)
- [GLaM: Generalist Language Model (GLaM)](https://ai.googleblog.com/2021/12/more-efficient-in-context-learning-with.html)

ูุจุงููุณุจุฉ ูู Pytorchุ ููุฏ ูุงูุช DeepSpeed ุจุจูุงุฆู ุฃูุถูุง: [DeepSpeed-MoE: Advancing Mixture-of-Experts Inference and Training to Power Next-Generation AI Scale](https://arxiv.org/abs/2201.05596)ุ [Mixture of Experts](https://www.deepspeed.ai/tutorials/mixture-of-experts/) - ููุดูุฑุงุช ุงููุฏููุฉ: [1](https://www.microsoft.com/en-us/research/blog/deepspeed-powers-8x-larger-moe-model-training-with-high-performance/)ุ [2](https://www.microsoft.com/en-us/research/publication/scalable-and-efficient-moe-training-for-multitask-multilingual-models/) ูุงููุดุฑ ุงููุญุฏุฏ ูุน ููุงุฐุฌ ุชูููุฏ ุงููุบุฉ ุงูุทุจูุนูุฉ ุงููุจูุฑุฉ ุงููุงุฆูุฉ ุนูู ุงููุญูู: [ููุดูุฑ ุงููุฏููุฉ](https://www.deepspeed.ai/2021/12/09/deepspeed-moe-nlg.html)ุ [ูุฑุน Megatron-Deepspeed](https://github.com/microsoft/Megatron-DeepSpeed/tree/moe-training).

## ุงุณุชุฎุฏุงู PyTorch native attention ูFlash Attention

ูููู ูู PyTorch [`torch.nn.functional.scaled_dot_product_attention`](https://pytorch.org/docs/master/generated/torch.nn.functional.scaled_dot_product_attention.html) (SDPA) ุฃูุถูุง ุงุณุชุฏุนุงุก FlashAttention ูุงูุชูุงูุงุช ูุนุงูุฉ ูู ุญูุซ ุงูุฐุงูุฑุฉ ูู ุงูุฎูููุฉ. ูุฌุฑู ุญุงูููุง ุฅุถุงูุฉ ุฏุนู SDPA ุจุดูู ุฃุตูู ูู Transformers ููุชู ุงุณุชุฎุฏุงูู ุจุดูู ุงูุชุฑุงุถู ูู `torch>=2.1.1` ุนูุฏ ุชููุฑ ุงูุชูููุฐ. ูุฑุฌู ุงูุฑุฌูุน ุฅูู [ุงูุชูุงู PyTorch ุจูููุชุฌ ุงูููุงุท ุงูููุฏุฑุฌ](https://huggingface.co/docs/transformers/perf_infer_gpu_one#pytorch-scaled-dot-product-attention) ููุญุตูู ุนูู ูุงุฆูุฉ ุจุงูููุงุฐุฌ ุงููุฏุนููุฉ ูุงููุฒูุฏ ูู ุงูุชูุงุตูู.

ุชููุฏ ูุฐุง [ุงูููุดูุฑ](https://pytorch.org/blog/out-of-the-box-acceleration/) ููุนุฑูุฉ ุงููุฒูุฏ ุญูู ุงูุชุณุฑูุน ููููุฑุงุช ุงูุฐุงูุฑุฉ ุจุงุณุชุฎุฏุงู SDPA.